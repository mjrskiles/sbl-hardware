{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://soundbytelabs.net/schema/sbl-lock.schema.json",
  "title": "Sound Byte Libs Lock File",
  "description": "Fully resolved hardware graph for reproducible builds",
  "type": "object",
  "required": ["version", "generated", "config_file", "sources", "resolution", "resolved_claims"],
  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON Schema reference"
    },
    "version": {
      "type": "string",
      "description": "Lock file schema version",
      "const": "1.0"
    },
    "generated": {
      "type": "string",
      "description": "ISO 8601 timestamp when lock file was generated",
      "format": "date-time"
    },
    "config_file": {
      "type": "string",
      "description": "Source configuration file (e.g., sbl.json)"
    },
    "sources": {
      "type": "object",
      "description": "Resolved source information",
      "additionalProperties": {
        "$ref": "#/definitions/resolved_source"
      }
    },
    "resolution": {
      "type": "object",
      "description": "Resolution chain information",
      "required": ["target", "mcu"],
      "properties": {
        "target": {
          "type": "string",
          "description": "Target board/module reference"
        },
        "chain": {
          "type": "array",
          "description": "Resolution chain (target -> parent -> ... -> root)",
          "items": {
            "type": "string"
          }
        },
        "mcu": {
          "type": "object",
          "description": "Resolved MCU information",
          "required": ["name", "source", "driver_path"],
          "properties": {
            "name": {
              "type": "string",
              "description": "MCU identifier"
            },
            "source": {
              "type": "string",
              "description": "MCU source reference"
            },
            "driver_path": {
              "type": "string",
              "description": "Relative path to driver within source"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "resolved_claims": {
      "type": "object",
      "description": "All claims resolved to MCU port/pin values",
      "properties": {
        "gpio": {
          "type": "object",
          "description": "Resolved GPIO claims",
          "additionalProperties": {
            "$ref": "#/definitions/resolved_gpio"
          }
        },
        "adc": {
          "type": "object",
          "description": "Resolved ADC claims",
          "additionalProperties": {
            "$ref": "#/definitions/resolved_adc"
          }
        }
      },
      "additionalProperties": false
    },
    "config": {
      "type": "object",
      "description": "Merged configuration from resolution chain",
      "additionalProperties": true
    }
  },
  "additionalProperties": false,

  "definitions": {
    "resolved_source": {
      "type": "object",
      "description": "Resolved source with commit information",
      "properties": {
        "github": {
          "type": "string",
          "description": "GitHub repository"
        },
        "path": {
          "type": "string",
          "description": "Local path"
        },
        "requested_ref": {
          "type": "string",
          "description": "Originally requested ref"
        },
        "resolved_commit": {
          "type": "string",
          "description": "Resolved git commit SHA"
        },
        "resolved_at": {
          "type": "string",
          "description": "When resolution occurred",
          "format": "date-time"
        }
      },
      "additionalProperties": false
    },

    "resolved_gpio": {
      "type": "object",
      "description": "Fully resolved GPIO handle",
      "required": ["port", "pin", "direction"],
      "properties": {
        "port": {
          "type": "integer",
          "description": "MCU port number",
          "minimum": 0
        },
        "pin": {
          "type": "integer",
          "description": "Pin number within port",
          "minimum": 0
        },
        "direction": {
          "type": "string",
          "enum": ["in", "out"]
        },
        "pull": {
          "type": "string",
          "enum": ["up", "down", "none"]
        },
        "active_low": {
          "type": "boolean",
          "default": false
        }
      },
      "additionalProperties": false
    },

    "resolved_adc": {
      "type": "object",
      "description": "Fully resolved ADC handle",
      "required": ["adc", "channel"],
      "properties": {
        "adc": {
          "type": "integer",
          "description": "ADC peripheral number",
          "minimum": 0
        },
        "channel": {
          "type": "integer",
          "description": "ADC channel number",
          "minimum": 0
        }
      },
      "additionalProperties": false
    }
  }
}
